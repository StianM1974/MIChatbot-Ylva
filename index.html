<!DOCTYPE html>
<html lang="no">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta charset="UTF-8">
  <title>MI-chatbot ‚Äì Ylva</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    #chat {
      border: 1px solid #ccc;
      padding: 20px;
      padding-bottom: 100px;             /* (uendret) */
      height: calc(100vh - 450px);       /* (uendret) */
      overflow-y: auto;
      background-color: #f9f9f9;
      margin-bottom: 10px;
    }
    .user { color: blue; margin: 10px 0; }
    .bot  { color: green; margin: 10px 0; }

    #avatar {
      float: left;
      margin-right: 15px;
      border-radius: 50%;
      width: 80px;
      height: 80px;
    }
    #instructions { overflow: hidden; margin-bottom: 20px; }

    /* --- inputbaren: identisk layout som sikkerhetskopien, MEN: egen rad for feedback p√• mobil --- */
    #inputContainer {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      margin: 0 auto;
      width: 100%; max-width: 800px;
      background: white;
      padding: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;               /* gj√∏r at rad 2 kan falle under p√• mobil */
      box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
      z-index: 100;
      gap: 6px;                      /* litt luft mellom radene p√• mobil */
    }

    /* wrapper rundt input + send + mic */
    .inputRow {
      display: flex;
      align-items: center;
      gap: 6px;
      width: 100%;                   /* slik at den kan bryte linje p√• mobil */
    }

    /* inputen (uendret, bortsett fra plass for mic-knapp) */
    .inputWrap {
      position: relative;
      flex: 1 1 auto;
      min-width: 200px;
    }
    #userInput {
      width: 100%;
      padding: 10px 38px 10px 10px;  /* plass til mic-knappen */
    }

    /* Send-knappen (uendret) */
    .btn-send {
      padding: 10px;
      margin: 5px 0;                 /* fjern side-margin for bedre plass i mobil-linje */
      white-space: nowrap;
    }

    /* Feedback-knappen: p√• mobil skal den ned p√• egen rad og midtstilles */
    .feedbackRow {
      width: 100%;
      display: none;                  /* desktop: skjult */
      justify-content: center;
    }
    .btn-feedback {
      padding: 10px;
      margin: 0;                      /* strammere look under input */
      white-space: nowrap;
    }

    /* Mikrofon-knappen (vises ikke i iOS/Safari). L√∏ftet 2px for sentrering. */
    #micBtn {
      position: absolute;
      right: 8px;
      top: calc(50% - 2px);           /* <- 2px opp */
      transform: translateY(-50%);
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      padding: 4px;
      display: none;                  /* vises via JS p√• st√∏ttede plattformer */
    }
    #micBtn:active { transform: translateY(calc(-50%)) scale(0.96); }

    /* --- Kun mobil: flytt feedback ned, hold input+send p√• √∏verste rad --- */
    @media (max-width: 720px) {
      .feedbackRow { display: flex; }     /* vis p√• egen rad */
      /* f√∏rste raden beholder input + send */
    }
  </style>
</head>
<body>
  <h1>MI-chatbot ‚Äì Case: Ylva</h1>
  <div id="instructions">
    <img id="avatar" src="/ylva.png" alt="Ylva avatar">
    <p><strong>Ylva (17)</strong> falt ut av videreg√•ende etter √• ha hatt kyssesyken. Hun ble hengende etter faglig og trakk seg unna sosialt, men hun har hatt gode karakterer tidligere og er motivert for √• komme tilbake. Hun er usikker p√• hvordan hun kan finne balansen mellom ambisjoner og √• ikke presse seg for hardt etter utmattelsen.</p>
    <p><strong>M√•l:</strong> Bygg relasjon og utforsk b√•de bekymringer, styrker og ideer for fremtiden. Ikke press, men hjelp henne √• reflektere rundt balanse og motivasjon.</p>
    <p><strong>MI-kurs:</strong> Arbeidspsykolog Stian Midtg√•rd arrangerer MI-kurs hvor du vil m√∏te Ylva og andre AI-bots.<br>
      <a href="https://www.arbeidspsykolog.no/webinar/" target="_blank">Les mer og meld deg p√•</a><br>
      <a href="https://mailchi.mp/arbeidspsykolog.no/f-oppdateringer-om-mi-bots-og-kurs" target="_blank">Registrer deg for nye AI-bots og nyheter</a></p>
    <p id="dictationTip" style="font-size: 0.9em; background:#f8fafc; border:1px solid #e5e7eb; padding:8px 10px; border-radius:6px; display:inline-block;"></p>
    <p style="font-size: 0.9em; margin-top:6px;">Dette er en Beta-versjon ‚Äì send gjerne kopi av samtalen om dere oppdager "bugs" til <a href="mailto:stian@arbeidspsykolog.no">stian@arbeidspsykolog.no</a></p>
  </div>

  <div id="chat"></div>

  <div id="inputContainer">
    <div class="inputRow">
      <div class="inputWrap">
        <input type="text" id="userInput" placeholder="Skriv noe til Ylva...">
        <button id="micBtn" title="Snakk" aria-label="Snakk">üé§</button>
      </div>
      <button class="btn-send" onclick="sendMessage()">Send</button>
    </div>

    <div class="feedbackRow">
      <button class="btn-feedback" onclick="getFeedback()">F√• evaluering (tar 5 sek)</button>
    </div>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const userInput = document.getElementById("userInput");
    const feedbackButton = document.querySelector(".btn-feedback");

    let conversation = [];
    const conversationId = `${new Date().toISOString().replace(/[:.]/g, "-")}_${Math.random().toString(36).slice(2,7)}`;
    const chatbotVersion = "Ylva_v1.0";

    /* --- UENDRET: scroll-h√•ndtering fra sikkerhetskopien --- */
    function appendMessage(sender, text, cssClass) {
      const message = document.createElement("div");
      message.className = cssClass;
      message.innerHTML = `<strong>${sender}:</strong> ${text}`;
      chat.appendChild(message);
      requestAnimationFrame(() => {
        chat.scrollTop = chat.scrollHeight;
      });
    }

    userInput.addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        sendMessage();
      }
    });

    async function sendMessage() {
      const userText = userInput.value;
      if (!userText) return;
      appendMessage("Du", userText, "user");
      conversation.push({ role: "user", content: userText });
      userInput.value = "";

      try {
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ conversation })
        });
        const data = await response.json();
        const txt = data.reply ?? data.message ?? "Feil: ingen respons.";
        appendMessage("Ylva", txt, "bot");
        conversation.push({ role: "assistant", content: txt });
      } catch (error) {
        appendMessage("System", "En feil oppstod i samtalen.", "bot");
        console.error("Feil fra API:", error);
      }
    }

    async function getFeedback() {
      const originalText = feedbackButton.innerText;
      feedbackButton.innerText = "Vurderer samtalen ‚Ä¶";
      feedbackButton.disabled = true;

      try {
        const response = await fetch("/api/feedback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ conversation })
        });
        const data = await response.json();
        const txt = data.reply ?? data.message ?? "Feil: ingen respons.";
        appendMessage("Ylva (tilbakemelding)", txt, "bot");
      } catch (error) {
        appendMessage("System", "En feil oppstod under tilbakemeldingen.", "bot");
        console.error("Feil fra API:", error);
      } finally {
        feedbackButton.innerText = originalText;
        feedbackButton.disabled = false;
      }
    }

    const resizeChat = () => {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
      const chatBox = document.getElementById("chat");
      chatBox.style.height = `calc(var(--vh, 1vh) * 100 - 450px)`;
    };
    window.addEventListener("resize", resizeChat);
    window.addEventListener("orientationchange", resizeChat);
    window.addEventListener("load", resizeChat);

    /* --- Tips-tekst per plattform --- */
    (function setDictationTip(){
      const tip = document.getElementById('dictationTip');
      const ua = navigator.userAgent.toLowerCase();
      const isIOS    = /iphone|ipad|ipod/.test(ua);
      const isAndroid= /android/.test(ua);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

      if (isIOS) {
        tip.textContent = "Tips (iPhone/iPad): Bruk mikrofon‚Äëikonet p√• tastaturet for diktering.";
      } else if (isSafari) {
        tip.innerHTML = `Tips (Safari p√• Mac): Aktiver ¬´Diktat¬ª i Systeminnstillinger ‚Üí Tastatur. <a href="https://support.apple.com/nb-no/HT202584" target="_blank" rel="noopener">Les hvordan</a>.`;
      } else if (isAndroid) {
        tip.textContent = "Tips (Android): Trykk mikrofon‚Äëikonet i skrivefeltet for diktering.";
      } else {
        tip.textContent = "Tips: I Chrome/Edge kan du bruke mikrofon‚Äëikonet i skrivefeltet for diktering.";
      }
    })();

    /* --- Mic-ikon synlighet: vis p√• alt unntatt iOS/Safari --- */
    (function showMicIfSupported(){
      const micBtn = document.getElementById("micBtn");
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      if (isIOS || isSafari) {
        micBtn.style.display = "none"; // skjul p√• iPhone/iPad og Safari
      } else {
        micBtn.style.display = "inline-block"; // vis ellers
      }
    })();
  </script>
</body>
</html>
