<!DOCTYPE html>
<html lang="no">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta charset="UTF-8">
  <title>MI-chatbot ‚Äì Ylva</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    #chat {
      border: 1px solid #ccc;
      padding: 20px;
      /* oppdateres i JS basert p√• h√∏yden til inputContainer */
      padding-bottom: 100px;
      height: calc(100vh - 450px);
      overflow-y: auto;
      background-color: #f9f9f9;
      margin-bottom: 10px;
      -webkit-overflow-scrolling: touch;
    }
    .user { color: blue; margin: 10px 0; }
    .bot  { color: green; margin: 10px 0; }

    #avatar {
      float: left;
      margin-right: 15px;
      border-radius: 50%;
      width: 80px;
      height: 80px;
    }
    #instructions { overflow: hidden; margin-bottom: 20px; }

    /* ====== INPUTRADEN (mobil f√∏rst) ====== */
    #inputContainer {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      margin: 0 auto;
      width: 100%; max-width: 800px;
      background: white;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      display: flex;
      flex-wrap: wrap;             /* mobil: to rader */
      align-items: center;
      gap: 8px;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
      z-index: 100;
      box-sizing: border-box;
    }

    /* √òverste rad (mobil): input + send */
    .inputRow {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
    }
    .inputWrap {
      position: relative;
      flex: 1 1 auto;
      min-width: 0;
    }
    #userInput {
      width: 100%;
      padding: 12px 38px 12px 12px; /* plass til mic */
      box-sizing: border-box;
      font-size: 16px;
      min-height: 42px;
    }
    #micBtn{
      position: absolute;
      right: 8px; top: 50%;
      transform: translateY(-50%);
      border: none; background: transparent;
      cursor: pointer; font-size: 18px; line-height: 1; padding: 4px;
      display: inline-block;
    }
    #micBtn:active{ transform: translateY(-50%) scale(0.95); }

    .btn-send {
      flex: 0 0 auto;
      white-space: nowrap;
      padding: 10px 12px;
      font-size: 14px;
    }

    /* Egen rad under (mobil): midtstilt evaluering */
    .feedbackRow {
      width: 100%;
      display: flex;
      justify-content: center;     /* mobil: midtstilt */
    }
    .btn-feedback {
      padding: 10px 12px;
      font-size: 14px;             /* lik som Send */
      white-space: nowrap;
    }

    /* Sm√• skjermer: kort placeholder */
    @media (max-width: 420px){
      #userInput::placeholder { content: "Skriv‚Ä¶"; }
    }

    /* ====== Desktop / store skjermer ====== */
    @media (min-width: 700px){
      #inputContainer {
        flex-wrap: nowrap;         /* √©n rad */
      }
      .inputRow {
        width: auto;
        flex: 1 1 auto;            /* tar tilgjengelig plass */
      }
      .feedbackRow {
        width: auto;
        justify-content: flex-start; /* ikke midtstilt p√• desktop */
      }
    }
  </style>
</head>
<body>
  <h1>MI-chatbot ‚Äì Case: Ylva</h1>
  <div id="instructions">
    <img id="avatar" src="/ylva.png" alt="Ylva avatar">
    <p><strong>Ylva (17)</strong> falt ut av videreg√•ende etter √• ha hatt kyssesyken. Hun ble hengende etter faglig og trakk seg unna sosialt, men hun har hatt gode karakterer tidligere og er motivert for √• komme tilbake. Hun er usikker p√• hvordan hun kan finne balansen mellom ambisjoner og √• ikke presse seg for hardt etter utmattelsen.</p>
    <p><strong>M√•l:</strong> Bygg relasjon og utforsk b√•de bekymringer, styrker og ideer for fremtiden. Ikke press, men hjelp henne √• reflektere rundt balanse og motivasjon.</p>
    <p><strong>MI-kurs:</strong> Arbeidspsykolog Stian Midtg√•rd arrangerer MI-kurs hvor du vil m√∏te Ylva og andre AI-bots.<br>
      <a href="https://www.arbeidspsykolog.no/webinar/" target="_blank">Les mer og meld deg p√•</a><br>
      <a href="https://mailchi.mp/arbeidspsykolog.no/f-oppdateringer-om-mi-bots-og-kurs" target="_blank">Registrer deg for nye AI-bots og nyheter</a></p>
    <p style="font-size: 0.9em;">Dette er en Beta-versjon ‚Äì send gjerne kopi av samtalen om dere oppdager "bugs" til <a href="mailto:stian@arbeidspsykolog.no">stian@arbeidspsykolog.no</a></p>
  </div>

  <div id="chat"></div>

  <!-- Input: mobil = to rader, desktop = √©n rad -->
  <div id="inputContainer">
    <div class="inputRow">
      <div class="inputWrap">
        <input type="text" id="userInput" placeholder="Skriv noe til Ylva...">
        <button id="micBtn" title="Snakk" aria-label="Snakk">üé§</button>
      </div>
      <button class="btn-send" onclick="sendMessage()">Send</button>
    </div>

    <div class="feedbackRow">
      <button class="btn-feedback" onclick="getFeedback()">F√• evaluering (tar 5 sek)</button>
    </div>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const userInput = document.getElementById("userInput");
    const inputBar = document.getElementById("inputContainer");
    const feedbackButton = document.querySelector(".btn-feedback");
    let conversation = [];

    const conversationId = `${new Date().toISOString().replace(/[:.]/g, "-")}_${Math.random().toString(36).slice(2,7)}`;
    const chatbotVersion = "Ylva_v1.0";

    // ===== iOS / mobil visuell viewport-fiks =====
    function applyViewportSizing() {
      const vv = window.visualViewport;
      const height = vv ? vv.height : window.innerHeight;
      const vh = height * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);

      // reserver plass til inputBar i bunnen av chat
      chat.style.paddingBottom = (inputBar.offsetHeight + 20) + 'px';

      // dynamisk h√∏yde for chat som ikke havner under tastaturet
      const approxHeader = 450; // matcher CSS-startpunktet
      const h = Math.max(160, (height - inputBar.offsetHeight - (approxHeader - 100)));
      chat.style.height = h + 'px';
    }
    window.visualViewport?.addEventListener('resize', applyViewportSizing);
    window.visualViewport?.addEventListener('scroll', applyViewportSizing);
    window.addEventListener('orientationchange', applyViewportSizing);
    window.addEventListener('load', applyViewportSizing);
    window.addEventListener('resize', applyViewportSizing);

    // s√∏rg for at felt + siste melding er synlig n√•r man fokuserer inputen
    userInput.addEventListener('focus', () => {
      setTimeout(() => {
        userInput.scrollIntoView({ block: 'nearest' });
        chat.scrollTop = chat.scrollHeight;
      }, 50);
    });

    // ===== chat-flyt =====
    userInput.addEventListener("keypress", function(event) {
      if (event.key === "Enter") sendMessage();
    });

    async function sendMessage() {
      const userText = userInput.value;
      if (!userText) return;
      appendMessage("Du", userText, "user");
      conversation.push({ role: "user", content: userText });
      userInput.value = "";

      try {
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ conversation })
        });

        const data = await response.json();
        const txt = data.reply ?? data.message ?? "Feil: ingen respons.";
        appendMessage("Ylva", txt, "bot");
        conversation.push({ role: "assistant", content: txt });
      } catch (error) {
        appendMessage("System", "En feil oppstod i samtalen.", "bot");
        console.error("Feil fra API:", error);
      } finally {
        applyViewportSizing();
      }
    }

    async function getFeedback() {
      const originalText = feedbackButton.innerText;
      feedbackButton.innerText = "Vurderer ‚Ä¶";
      feedbackButton.disabled = true;

      try {
        const response = await fetch("/api/feedback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ conversation })
        });

        const data = await response.json();
        const txt = data.reply ?? data.message ?? "Feil: ingen respons.";
        appendMessage("Ylva (tilbakemelding)", txt, "bot");
      } catch (error) {
        appendMessage("System", "En feil oppstod under tilbakemeldingen.", "bot");
        console.error("Feil fra API:", error);
      } finally {
        feedbackButton.innerText = originalText;
        feedbackButton.disabled = false;
        applyViewportSizing();
      }
    }

    function appendMessage(sender, text, cssClass) {
      const message = document.createElement("div");
      message.className = cssClass;
      message.innerHTML = `<strong>${sender}:</strong> ${text}`;
      chat.appendChild(message);
      requestAnimationFrame(() => { chat.scrollTop = chat.scrollHeight; });
    }

   // --- Mikrofon-ikon: opptak (Whisper) p√• ikke-iOS/Safari ---
(function setupVoiceUI() {
  const micBtn = document.getElementById("micBtn");

  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

  // iOS/Safari: bruk tastaturets innebygde diktering
  if (isIOS || isSafari) {
    micBtn.style.display = "inline-block";
    micBtn.addEventListener("click", () => {
      alert("P√• iPhone/Safari: bruk mikrofon-ikonet p√• tastaturet for diktering.");
    });
    return;
  }

  // Andre plattformer: opptak via MediaRecorder -> Whisper
  const supportsMediaRecorder = typeof window.MediaRecorder !== "undefined";
  if (!supportsMediaRecorder) {
    micBtn.style.display = "inline-block";
    micBtn.addEventListener("click", () => {
      alert("Nettleseren st√∏tter ikke opptak her. Skriv eller bruk annen nettleser (Chrome/Edge).");
    });
    return;
  }

  micBtn.style.display = "inline-block";

  let mediaRecorder = null;
  let chunks = [];
  let recording = false;

  micBtn.addEventListener("click", async () => {
    try {
      if (!recording) {
        // Start
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        chunks = [];
        mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
        mediaRecorder.ondataavailable = (e) => e.data.size && chunks.push(e.data);
        mediaRecorder.onstop = async () => {
          const blob = new Blob(chunks, { type: "audio/webm" });
          const arrayBuffer = await blob.arrayBuffer();

          // Convert to base64 safely
          const uint8 = new Uint8Array(arrayBuffer);
          let binary = "";
          for (let i = 0; i < uint8.length; i++) binary += String.fromCharCode(uint8[i]);
          const base64 = btoa(binary);

          // Send to /api/transcribe
          const res = await fetch("/api/transcribe", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              audioBase64: base64,
              mimeType: blob.type,
              language: "no"
            })
          });

          const data = await res.json();
          if (data?.text) {
            const field = document.getElementById("userInput");
            field.value = data.text.trim();
            field.focus();
          } else {
            alert("Kunne ikke transkribere lyd.");
          }

          // stop mics
          stream.getTracks().forEach(t => t.stop());
          micBtn.textContent = "üé§";
          recording = false;
        };

        mediaRecorder.start();
        micBtn.textContent = "‚ñ†"; // opptak p√•g√•r
        recording = true;
      } else {
        // Stop
        mediaRecorder?.stop();
      }
    } catch (err) {
      console.error("Opptaksfeil:", err);
      alert("Fikk ikke startet opptak. Tillat mikrofon og pr√∏v igjen.");
      micBtn.textContent = "üé§";
      recording = false;
    }
  });
})();

    // initial layout
    applyViewportSizing();
      // --- Mikrofon-ikon: Web Speech API (Chrome/Edge/Android) + iOS-hint + Whisper fallback ---
  (function setupVoiceUI() {
    const micBtn = document.getElementById("micBtn");
    const userInput = document.getElementById("userInput");
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    // 1) iOS / Safari -> bruk tastaturets innebygde diktering
    if (isIOS || isSafari) {
      micBtn.style.display = "inline-block";
      micBtn.addEventListener("click", () => {
        alert("P√• iPhone/Safari: bruk mikrofon-ikonet p√• tastaturet for diktering.");
      });
      return;
    }

    // 2) Chrome/Edge/Android: Web Speech API (best UX)
    if (SpeechRecognition) {
      micBtn.style.display = "inline-block";
      let recognizing = false;
      let recognition;

      const startRecognition = () => {
        if (recognizing) return;
        recognition = new SpeechRecognition();
        recognition.lang = "no-NO";
        recognition.interimResults = true;   // viser live mens man snakker
        recognition.continuous = false;      // auto-stopper p√• stillhet

        let finalText = "";
        micBtn.textContent = "üéôÔ∏è lytter‚Ä¶";
        recognizing = true;

        recognition.onresult = (e) => {
          let interim = "";
          for (let i = e.resultIndex; i < e.results.length; ++i) {
            const t = e.results[i][0].transcript;
            if (e.results[i].isFinal) finalText += t;
            else interim += t;
          }
          // viser alltid teksten i inputfeltet, ikke send automatisk
          userInput.value = (finalText + " " + interim).trim();
        };

        recognition.onerror = () => {
          micBtn.textContent = "üé§";
          recognizing = false;
        };

        recognition.onend = () => {
          micBtn.textContent = "üé§";
          recognizing = false;
          // sluttresultatet ligger n√• i userInput, klart til √• redigeres og sendes
        };

        recognition.start();
      };

      const stopRecognition = () => {
        try { recognition && recognition.stop(); } catch {}
      };

      // Trykk for √• starte/stoppe
      micBtn.addEventListener("click", () => {
        recognizing ? stopRecognition() : startRecognition();
      });
      return;
    }

    // 3) Fallback (andre nettlesere): behold Whisper-opptak (du har allerede /api/transcribe)
    micBtn.style.display = "inline-block";
    micBtn.addEventListener("click", () => {
      alert("Nettleseren st√∏tter ikke diktering. Vi bruker snart Whisper her ‚Äì skriv inntil videre eller pr√∏v Chrome.");
    });
  })();
  // --- /Mikrofon-ikon ---
  </script>
</body>
</html>
