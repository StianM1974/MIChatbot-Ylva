<!DOCTYPE html>
<html lang="no">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta charset="UTF-8">
  <title>MI-chatbot – Ylva</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    #chat {
      border: 1px solid #ccc;
      padding: 20px;
      padding-bottom: 100px;
      height: calc(100vh - 450px);
      overflow-y: auto;
      background-color: #f9f9f9;
      margin-bottom: 10px;
    }
    .user { color: blue; margin: 10px 0; }
    .bot  { color: green; margin: 10px 0; }

    #avatar {
      float: left;
      margin-right: 15px;
      border-radius: 50%;
      width: 80px;
      height: 80px;
    }
    #instructions { overflow: hidden; margin-bottom: 20px; }

    #inputContainer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      margin: 0 auto;
      width: 100%;
      max-width: 800px;
      background: white;
      padding: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    /* behold original input-styling */
    #userInput {
      flex: 1;
      padding: 10px;
      min-width: 200px;
      margin-right: 5px;
    }
    button { padding: 10px; margin: 5px; }

    /* --- Mic-stil (brukes kun når mic aktiveres) --- */
    .inputWrap { position: relative; flex: 1; }
    #userInput.has-mic { padding-right: 44px; } /* litt plass til mic-knapp */
    #micBtn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      width: 32px;
      height: 32px;
      border-radius: 9999px;
      display: none;              /* vises via JS når støttet */
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease, box-shadow .2s ease, transform .05s ease;
    }
    #micBtn:hover { background: #eef0f3; }
    #micBtn:active { transform: translateY(-50%) scale(0.98); }
    #micBtn svg { width: 16px; height: 16px; stroke: #111827; display: block; }

    /* Ripple ved opptak */
    #micBtn.recording {
      background: #fee2e2;
      border-color: #fecaca;
      box-shadow: 0 0 0 0 rgba(239,68,68,0.5);
      animation: micpulse 1.5s ease-out infinite;
    }
    #micBtn.recording svg { stroke: #b91c1c; }
    @keyframes micpulse {
      0%   { box-shadow: 0 0 0 0 rgba(239,68,68,0.5); }
      70%  { box-shadow: 0 0 0 10px rgba(239,68,68,0.0); }
      100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.0); }
    }

    /* Tips-linje i infofeltet (liten og diskret) */
    #dictationTip {
      font-size: 0.9em;
      opacity: .85;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <h1>MI-chatbot – Case: Ylva</h1>
  <div id="instructions">
    <img id="avatar" src="/ylva.png" alt="Ylva avatar">
    <p><strong>Ylva (17)</strong> falt ut av videregående etter å ha hatt kyssesyken. Hun ble hengende etter faglig og trakk seg unna sosialt, men hun har hatt gode karakterer tidligere og er motivert for å komme tilbake. Hun er usikker på hvordan hun kan finne balansen mellom ambisjoner og å ikke presse seg for hardt etter utmattelsen.</p>
    <p><strong>Mål:</strong> Bygg relasjon og utforsk både bekymringer, styrker og ideer for fremtiden. Ikke press, men hjelp henne å reflektere rundt balanse og motivasjon.</p>
    <p><strong>MI-kurs:</strong> Arbeidspsykolog Stian Midtgård arrangerer MI-kurs hvor du vil møte Ylva og andre AI-bots.<br>
    <a href="https://www.arbeidspsykolog.no/webinar/" target="_blank">Les mer og meld deg på</a><br>
    <a href="https://mailchi.mp/arbeidspsykolog.no/f-oppdateringer-om-mi-bots-og-kurs" target="_blank">Registrer deg for nye AI-bots og nyheter</a></p>
    <p style="font-size: 0.9em;">Dette er en Beta-versjon – send gjerne kopi av samtalen om dere oppdager "bugs" til <a href="mailto:stian@arbeidspsykolog.no">stian@arbeidspsykolog.no</a></p>
    <!-- Tips-linje fylles inn av JS -->
    <p id="dictationTip"></p>
  </div>

  <div id="chat"></div>

  <div id="inputContainer">
    <input type="text" id="userInput" placeholder="Skriv noe til Ylva...">
    <button onclick="sendMessage()">Send</button>
    <button onclick="getFeedback()">Få evaluering (tar 5 sek)</button>
  </div>

  <script>
    const chat = document.getElementById("chat");
    let userInput = document.getElementById("userInput"); // kan byttes ut med wrapper under
    const feedbackButton = document.querySelector("#inputContainer button:last-of-type");
    let conversation = [];

    const conversationId = `${new Date().toISOString().replace(/[:.]/g, "-")}_${Math.random().toString(36).slice(2,7)}`;
    const chatbotVersion = "Ylva_v1.0";

    /* ====== Uendret chat-flyt ====== */
    userInput.addEventListener("keypress", function(event) {
      if (event.key === "Enter") sendMessage();
    });

    async function sendMessage() {
      const userText = userInput.value;
      if (!userText) return;
      appendMessage("Du", userText, "user");
      conversation.push({ role: "user", content: userText });
      userInput.value = "";

      try {
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ conversation })
        });
        const data = await response.json();
        const txt = data.reply ?? data.message ?? "Feil: ingen respons.";
        appendMessage("Ylva", txt, "bot");
        conversation.push({ role: "assistant", content: txt });
      } catch (error) {
        appendMessage("System", "En feil oppstod i samtalen.", "bot");
        console.error("Feil fra API:", error);
      }
    }

    async function getFeedback() {
      const originalText = feedbackButton.innerText;
      feedbackButton.innerText = "Vurderer samtalen …";
      feedbackButton.disabled = true;

      try {
        const response = await fetch("/api/feedback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ conversation })
        });
        const data = await response.json();
        const txt = data.reply ?? data.message ?? "Feil: ingen respons.";
        appendMessage("Ylva (tilbakemelding)", txt, "bot");
      } catch (error) {
        appendMessage("System", "En feil oppstod under tilbakemeldingen.", "bot");
        console.error("Feil fra API:", error);
      } finally {
        feedbackButton.innerText = originalText;
        feedbackButton.disabled = false;
      }
    }

    function appendMessage(sender, text, cssClass) {
      const message = document.createElement("div");
      message.className = cssClass;
      message.innerHTML = `<strong>${sender}:</strong> ${text}`;
      chat.appendChild(message);
      requestAnimationFrame(() => { chat.scrollTop = chat.scrollHeight; });
    }

    const resizeChat = () => {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
      const chatBox = document.getElementById("chat");
      chatBox.style.height = `calc(var(--vh, 1vh) * 100 - 450px)`;
    };
    window.addEventListener("resize", resizeChat);
    window.addEventListener("orientationchange", resizeChat);
    window.addEventListener("load", resizeChat);

    /* ====== Mic + tips (kun der Web Speech API er støttet, og ikke iOS/Safari) ====== */
    (function setupDictationUI() {
      const ua = navigator.userAgent;
      const isIOS = /iPad|iPhone|iPod/.test(ua);
      const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const supportsWebSpeech = !!SpeechRecognition;

      const tip = document.getElementById("dictationTip");

      // Tips-tekst i infofeltet
      if (isIOS) {
        tip.textContent = "Tips (iPhone/iPad): Bruk mikrofon-ikonet på tastaturet for diktering.";
      } else if (isSafari) {
        tip.textContent = "Tips (Safari): Aktiver ‘Diktering’ i Systeminnstillinger → Tastatur for tale-til-tekst.";
      } else if (supportsWebSpeech) {
        tip.textContent = "Tips: Du kan diktere med mikrofon-ikonet ved skrivefeltet (Chrome/Edge/Android).";
      } else {
        tip.textContent = "Tips: Tale-til-tekst støttes best i Chrome/Edge eller via enhetens innebygde diktering.";
      }

      // Vi viser IKKE eget mic-ikon på iOS eller Safari (for å unngå forvirring)
      if (isIOS || isSafari || !supportsWebSpeech) return;

      // 1) Pakk input i en wrapper og legg til mic-knapp inne i feltet (uten å endre layout ellers)
      const inputContainer = document.getElementById("inputContainer");
      const originalInput = document.getElementById("userInput");

      const wrap = document.createElement("div");
      wrap.className = "inputWrap";          // pos:relative, tar samme plass som input (flex:1)
      originalInput.parentNode.insertBefore(wrap, originalInput);
      wrap.appendChild(originalInput);

      // Oppdatér padding på input for å gi plass til mic-knappen
      originalInput.classList.add("has-mic");

      // Lag mic-knappen (SVG som ligner ChatGPT)
      const micBtn = document.createElement("button");
      micBtn.id = "micBtn";
      micBtn.title = "Snakk";
      micBtn.setAttribute("aria-label", "Snakk");
      micBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M12 3a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V6a3 3 0 0 0-3-3z"/>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
          <path d="M12 19v3"/>
        </svg>`;
      micBtn.style.display = "inline-flex";
      wrap.appendChild(micBtn);

      // 2) Web Speech API – “live” diktering som fyller input (ikke auto-send)
      let recognizing = false;
      let recognition;

      const startRecognition = () => {
        if (recognizing) return;
        recognition = new SpeechRecognition();
        recognition.lang = "no-NO";
        recognition.interimResults = true;
        recognition.continuous = false; // stopper typisk på stillhet

        let finalText = "";
        micBtn.classList.add("recording");
        micBtn.setAttribute("aria-label", "Lytter…");

        recognition.onresult = (e) => {
          let interim = "";
          for (let i = e.resultIndex; i < e.results.length; ++i) {
            const t = e.results[i][0].transcript;
            if (e.results[i].isFinal) finalText += t;
            else interim += t;
          }
          originalInput.value = (finalText + " " + interim).trim();
        };

        recognition.onerror = () => {
          micBtn.classList.remove("recording");
          micBtn.setAttribute("aria-label", "Snakk");
          recognizing = false;
        };

        recognition.onend = () => {
          micBtn.classList.remove("recording");
          micBtn.setAttribute("aria-label", "Snakk");
          recognizing = false;
        };

        recognizing = true;
        recognition.start();
      };

      const stopRecognition = () => {
        try { recognition && recognition.stop(); } catch {}
      };

      micBtn.addEventListener("click", () => {
        recognizing ? stopRecognition() : startRecognition();
      });
    })();
  </script>
</body>
</html>
