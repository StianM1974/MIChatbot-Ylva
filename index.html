<!DOCTYPE html>
<html lang="no">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta charset="UTF-8">
 a <title>MI-chatbot – Ylva</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    #chat {
      border: 1px solid #ccc;
      padding: 20px;
      padding-bottom: 100px;
      height: calc(100vh - 450px);
      overflow-y: auto;
      background-color: #f9f9f9;
      margin-bottom: 10px;
    }
    .user {
      color: blue;
      margin: 10px 0;
    }
    .bot {
      color: green;
      margin: 10px 0;
    }
    #avatar {
      float: left;
      margin-right: 15px;
      border-radius: 50%;
      width: 80px;
      height: 80px;
    }
    #instructions {
      overflow: hidden;
      margin-bottom: 20px;
    }
    #inputContainer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      margin: 0 auto;
      width: 100%;
      max-width: 800px;
      background: white;
      padding: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    #userInput {
      flex: 1;
      padding: 10px;
      min-width: 200px;
      margin-right: 5px;
    }
    button {
      padding: 10px;
      margin: 5px;
    }

    /* --- MIK-IKON: stiler legges til uten å endre eksisterende layout --- */
    .inputWrap {
      position: relative;
      flex: 1 1 auto;
      min-width: 200px;
      margin-right: 5px;
      display: flex;
    }
    .inputWrap > #userInput {
      flex: 1 1 auto;
      width: 100%;
      padding-right: 44px;
      margin-right: 0;
    }
    #micBtn {
      position: absolute;
      right: 8px; top: 50%;
      transform: translateY(-50%);
      width: 32px; height: 32px;
      border-radius: 9999px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease, box-shadow .2s ease, transform .05s ease;
    }
    #micBtn:hover { background: #eef0f3; }
    #micBtn:active { transform: translateY(-50%) scale(0.98); }

    #micBtn svg {
      width: 16px; height: 16px;
      display: block;
      stroke: #111827;
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    #micBtn.recording {
      background: #fee2e2;
      border-color: #fecaca;
      box-shadow: 0 0 0 0 rgba(239,68,68,0.50);
      animation: micpulse 1.5s ease-out infinite;
    }
    #micBtn.recording svg { stroke: #b91c1c; }

    @keyframes micpulse {
      0%   { box-shadow: 0 0 0 0 rgba(239,68,68,0.50); }
      70%  { box-shadow: 0 0 0 10px rgba(239,68,68,0.0); }
      100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.0); }
    }
    /* --- /MIK-IKON --- */
  </style>
</head>
<body>
  <h1>MI-chatbot – Case: Ylva</h1>
 <div id="instructions">
  <img id="avatar" src="/ylva.png" alt="Ylva avatar">
  <p><strong>Ylva (17):</strong> Falt ut av videregående etter kyssesyken. Hang etter faglig og trakk seg unna sosialt, men har hatt gode karakterer og ønsker å komme tilbake. Hun er motivert, men usikker på hvordan hun kan balansere ambisjoner uten å presse seg for hardt.</p>

  <p><strong>Mål:</strong> Bygg relasjon og utforsk bekymringer, ønsker og planer. Hjelp henne å reflektere rundt balanse og motivasjon.</p>

  <p><strong>MI-kurs:</strong> Arbeidspsykolog Stian Midtgård arrangerer MI-kurs hvor du møter Ylva og andre AI-bots.
    <a href="https://www.arbeidspsykolog.no/webinar/" target="_blank">Les mer og meld deg på</a>.
    <a href="https://mailchi.mp/arbeidspsykolog.no/f-oppdateringer-om-mi-bots-og-kurs" target="_blank">Registrer deg for nye AI-bots og nyheter</a>.
  </p>

  <p style="font-size: 0.9em;"><em>Beta-versjon – meld inn eventuelle «bugs» til <a href="mailto:stian@arbeidspsykolog.no">stian@arbeidspsykolog.no</a></em></p>
</div>

  <div id="chat"></div>

  <div id="inputContainer">
    <input type="text" id="userInput" placeholder="Skriv noe til Ylva...">
    <button onclick="sendMessage()">Send</button>
    <button onclick="getFeedback()">Få evaluering (tar 5 sek)</button>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const userInput = document.getElementById("userInput");
    const feedbackButton = document.querySelector("#inputContainer button:last-of-type");
    let conversation = [];

    const conversationId = `${new Date().toISOString().replace(/[:.]/g, "-")}_${Math.random().toString(36).slice(2,7)}`;
    const chatbotVersion = "Ylva_v1.0";

    // --- NYTT: mer robust autoscroll (Chrome) ---
    function scrollToBottom() {
      requestAnimationFrame(() => {
        chat.scrollTop = chat.scrollHeight;
        requestAnimationFrame(() => {
          chat.scrollTop = chat.scrollHeight;
        });
      });
    }
    // --- /NYTT ---

    userInput.addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        sendMessage();
      }
    });

    async function sendMessage() {
      const userText = userInput.value;
      if (!userText) return;
      appendMessage("Du", userText, "user");
      conversation.push({ role: "user", content: userText });
      userInput.value = "";

      try {
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ conversation })
        });

        const data = await response.json();
        const txt = data.reply ?? data.message ?? "Feil: ingen respons.";
        appendMessage("Ylva", txt, "bot");
        conversation.push({ role: "assistant", content: txt });
      } catch (error) {
        appendMessage("System", "En feil oppstod i samtalen.", "bot");
        console.error("Feil fra API:", error);
      }
    }

    async function getFeedback() {
      const originalText = feedbackButton.innerText;
      feedbackButton.innerText = "Vurderer samtalen …";
      feedbackButton.disabled = true;

      try {
        const response = await fetch("/api/feedback", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ conversation: conversation })
        });

        const data = await response.json();
        const txt = data.reply ?? data.message ?? "Feil: ingen respons.";
        appendMessage("Ylva (tilbakemelding)", txt, "bot");
      } catch (error) {
        appendMessage("System", "En feil oppstod under tilbakemeldingen.", "bot");
        console.error("Feil fra API:", error);
      } finally {
        feedbackButton.innerText = originalText;
        feedbackButton.disabled = false;
      }
    }

    function appendMessage(sender, text, cssClass) {
      const message = document.createElement("div");
      message.className = cssClass;
      message.innerHTML = `<strong>${sender}:</strong> ${text}`;
      chat.appendChild(message);
      // Endret: bruk mer robust autoscroll
      scrollToBottom();
    }

    const resizeChat = () => {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
      const chatBox = document.getElementById("chat");
      chatBox.style.height = `calc(var(--vh, 1vh) * 100 - 450px)`;
    };

    window.addEventListener("resize", resizeChat);
    window.addEventListener("orientationchange", resizeChat);
    window.addEventListener("load", resizeChat);

    // === Mic-ikon (kun ikke-iOS/Safari). Minimalt inngrep i DOM/layout ===
    (function addMicIfSupported() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      if (isIOS || isSafari) return; // ikke vis mic her

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      // Pakk inn input i en wrapper, uten å endre flex-oppsett
      const input = document.getElementById('userInput');
      const container = document.getElementById('inputContainer');

      // Lag wrapper foran input, ta over flex:1-plassen
      const wrap = document.createElement('div');
      wrap.className = 'inputWrap';
      container.insertBefore(wrap, input);
      wrap.appendChild(input);

     // Lag mic-knapp (SVG som i ChatGPT-stil) – justert plassering
const micBtn = document.createElement('button');
micBtn.id = 'micBtn';
micBtn.type = 'button';
micBtn.title = 'Snakk';
micBtn.setAttribute('aria-label','Snakk');
micBtn.style.position = "absolute";
micBtn.style.right = "8px";
micBtn.style.top = "39%";
micBtn.style.transform = "translateY(-50%)";  // sikrer midtstilling
micBtn.style.width = "32px";
micBtn.style.height = "32px";
micBtn.style.borderRadius = "9999px";
micBtn.style.border = "1px solid #e5e7eb";
micBtn.style.background = "#f3f4f6";
micBtn.style.display = "inline-flex";
micBtn.style.alignItems = "center";
micBtn.style.justifyContent = "center";
micBtn.style.padding = "0";
micBtn.style.cursor = "pointer";

micBtn.innerHTML = `
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M12 3a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V6a3 3 0 0 0-3-3z"></path>
    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
    <path d="M12 19v3"></path>
  </svg>
`;
wrap.appendChild(micBtn);

if (!SpeechRecognition) {
  micBtn.addEventListener('click', () => {
    alert('Diktering støttes ikke i denne nettleseren. Prøv Chrome eller Edge.');
  });
  return;
}

// Sticky, pause-tolerant dictation for Chrome/Edge
let recognizing = false;
let userStopped = false;   // user explicitly toggled off
let sticky = false;        // mic stays "on" until clicked again
let recognition;
let baseText = "";         // accumulate final results

const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

// Gjør tilgjengelig for resten av appen (valgfritt kall fra sendMessage)
window.micReset = function () { baseText = ""; };

// Nullstill også hvis feltet blir tømt (f.eks. etter Send)
input.addEventListener('input', () => {
  if (input.value.trim() === "") baseText = "";
});

function startRecognition() {
  if (recognizing) return;
  recognition = new SR();
  recognition.lang = "no-NO";
  recognition.interimResults = true;
  recognition.continuous = true;  // tolerate pauses

  // continue from what’s already in the input
  baseText = input.value.trim();
  userStopped = false;
  recognizing = true;

  micBtn.classList.add('recording');
  micBtn.setAttribute('aria-label','Lytter…');

  recognition.onresult = (e) => {
    let interim = "";
    for (let i = e.resultIndex; i < e.results.length; ++i) {
      const t = e.results[i][0].transcript;
      if (e.results[i].isFinal) {
        baseText = (baseText ? baseText + " " : "") + t.trim();
      } else {
        interim += t;
      }
    }
    input.value = (baseText + (interim ? " " + interim.trim() : "")).trim();
  };

  const cleanUI = () => {
    recognizing = false;
    // keep ripple if sticky (we will restart silently)
    if (!sticky) {
      micBtn.classList.remove('recording');
      micBtn.setAttribute('aria-label','Snakk');
    } else {
      micBtn.setAttribute('aria-label','Lytter…');
    }
  };

  recognition.onerror = () => {
    cleanUI();
    if (!userStopped && sticky) {
      setTimeout(() => { try { startRecognition(); } catch {} }, 100);
    }
  };

  recognition.onend = () => {
    cleanUI();
    // some platforms end on silence — auto-restart if sticky
    if (!userStopped && sticky) {
      setTimeout(() => { try { startRecognition(); } catch {} }, 100);
    }
  };

  recognition.start();
}

function stopRecognition() {
  userStopped = true;
  try { recognition && recognition.stop(); } catch {}
}

// Toggle sticky on click (én lytter)
micBtn.addEventListener('click', () => {
  if (!sticky) {
    sticky = true;
    startRecognition();
  } else {
    sticky = false;
    stopRecognition();
  }
});
    })();
    // === /Mic-ikon ===
  </script>
</body>
</html>
