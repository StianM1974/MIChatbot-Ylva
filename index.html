<!DOCTYPE html>
<html lang="no">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta charset="UTF-8">
  <title>MI-chatbot – Ylva</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    #chat {
      border: 1px solid #ccc;
      padding: 20px;
      padding-bottom: 100px;
      height: calc(100vh - 450px);
      overflow-y: auto;
      background-color: #f9f9f9;
      margin-bottom: 10px;
    }
    .user {
      color: blue;
      margin: 10px 0;
    }
    .bot {
      color: green;
      margin: 10px 0;
    }
    #avatar {
      float: left;
      margin-right: 15px;
      border-radius: 50%;
      width: 80px;
      height: 80px;
    }
    #instructions {
      overflow: hidden;
      margin-bottom: 20px;
    }
    #inputContainer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      margin: 0 auto;
      width: 100%;
      max-width: 800px;
      background: white;
      padding: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    #userInput {
      flex: 1;
      padding: 10px;
      min-width: 200px;
      margin-right: 5px;
    }
    button {
      padding: 10px;
      margin: 5px;
    }
  </style>
</head>
<body>
  <h1>MI-chatbot – Case: Ylva</h1>
  <div id="instructions">
    <img id="avatar" src="https://oaidalleapiprodscus.blob.core.windows.net/private/org-3QKjRE0Kr0LOtu0cB4HWtO4Q/user-oj7qTf1aDz0ikF7t1M8iiGAM/img-2G5aW5cK4TmZC3VhW5zIlKBr.png?st=2025-08-17T12%3A00%3A00Z&se=2025-08-17T18%3A00%3A00Z&sp=r&sv=2025-02-19&sr=b&rscd=inline&rsct=image/png&skoid=6f0f3c5d-3e5e-4693-a8f6-40d11fb6885b&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2025-08-16T12%3A00%3A00Z&ske=2025-08-18T12%3A00%3A00Z&sks=b&skv=2025-02-19&sig=ZtJvV8O1qZg5FhTZKxjCrZ5qA87kF1ykq3j3MT6YJxY%3D" alt="Ylva avatar">
    <p><strong>Ylva (17)</strong> falt ut av videregående etter å ha hatt kyssesyken og opplevd mye utmattelse. Hun ble hengende etter faglig og sosialt, og har mistet litt kontakten med miljøet. Hun har tidligere hatt veldig gode karakterer og er ambisiøs, men er usikker på hvordan hun skal finne balansen mellom å satse og ikke presse seg for hardt igjen.</p>
    <p><strong>Mål:</strong> Utforsk hvordan Ylva tenker om fremtiden, hennes ambisjoner, bekymringer og ideer for å komme tilbake til skolen. Bygg relasjon og støtt refleksjon uten å presse.</p>
    <p><strong>MI-kurs:</strong> Arbeidspsykolog Stian Midtgård arrangerer MI-kurs hvor du vil møte Ylva og andre AI-bots.<br>
    <a href="https://www.arbeidspsykolog.no/webinar/" target="_blank">Les mer og meld deg på</a><br>
    <a href="https://mailchi.mp/arbeidspsykolog.no/f-oppdateringer-om-mi-bots-og-kurs" target="_blank">Registrer deg for nye AI-bots og nyheter</a></p>
    <p style="font-size: 0.9em;">Dette er en Beta-versjon – send gjerne kopi av samtalen om dere oppdager "bugs" til <a href="mailto:stian@arbeidspsykolog.no">stian@arbeidspsykolog.no</a></p>
  </div>

  <div id="chat"></div>

  <div id="inputContainer">
    <input type="text" id="userInput" placeholder="Skriv noe til Ylva...">
    <button onclick="sendMessage()">Send</button>
    <button onclick="getFeedback()">Få evaluering (tar 5 sek)</button>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const userInput = document.getElementById("userInput");
    const feedbackButton = document.querySelector("#inputContainer button:last-of-type");
    let conversation = [];

    userInput.addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        sendMessage();
      }
    });

    async function sendMessage() {
      const userText = userInput.value;
      if (!userText) return;
      appendMessage("Du", userText, "user");
      conversation.push({ role: "user", content: userText });
      userInput.value = "";

      try {
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ conversation })
        });

        const data = await response.json();
        appendMessage("Ylva", data.message, "bot");
        conversation.push({ role: "assistant", content: data.message });
      } catch (error) {
        appendMessage("System", "En feil oppstod i samtalen.", "bot");
        console.error("Feil fra API:", error);
      }
    }

    async function getFeedback() {
      const originalText = feedbackButton.innerText;
      feedbackButton.innerText = "Vurderer samtalen …";
      feedbackButton.disabled = true;

      try {
        const response = await fetch("/api/feedback", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ conversation: conversation })
        });

        const data = await response.json();
        appendMessage("Ylva (tilbakemelding)", data.message, "bot");
      } catch (error) {
        appendMessage("System", "En feil oppstod under tilbakemeldingen.", "bot");
        console.error("Feil fra API:", error);
      } finally {
        feedbackButton.innerText = originalText;
        feedbackButton.disabled = false;
      }
    }

    function appendMessage(sender, text, cssClass) {
      const message = document.createElement("div");
      message.className = cssClass;
      message.innerHTML = `<strong>${sender}:</strong> ${text}`;
      chat.appendChild(message);
      requestAnimationFrame(() => {
        chat.scrollTop = chat.scrollHeight;
      });
    }

    const resizeChat = () => {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
      const chatBox = document.getElementById("chat");
      chatBox.style.height = `calc(var(--vh, 1vh) * 100 - 450px)`;
    };

    window.addEventListener("resize", resizeChat);
    window.addEventListener("orientationchange", resizeChat);
    window.addEventListener("load", resizeChat);
  </script>
</body>
</html>
